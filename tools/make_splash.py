#!/usr/bin/env python3
import os

W = 320
H = 240
OUT = "assets/sdroot/splash.raw"

FONT = {
    "A": [0x18,0x24,0x42,0x7E,0x42,0x42,0x42,0x00],
    "B": [0x7C,0x42,0x42,0x7C,0x42,0x42,0x7C,0x00],
    "E": [0x7E,0x40,0x40,0x7C,0x40,0x40,0x7E,0x00],
    "H": [0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x00],
    "I": [0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00],
    "L": [0x40,0x40,0x40,0x40,0x40,0x40,0x7E,0x00],
    "M": [0x42,0x66,0x5A,0x5A,0x42,0x42,0x42,0x00],
    "P": [0x7C,0x42,0x42,0x7C,0x40,0x40,0x40,0x00],
    "1": [0x08,0x18,0x28,0x08,0x08,0x08,0x3E,0x00],
    "S": [0x3C,0x42,0x40,0x3C,0x02,0x42,0x3C,0x00],
    "T": [0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00],
    " ": [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
}

def rgb565(r, g, b):
    return ((r & 0xF8) << 8) | ((g & 0xFC) << 3) | (b >> 3)

def draw_char(buf, x0, y0, ch, color):
    glyph = FONT.get(ch, FONT[" "])
    for y in range(8):
      row = glyph[y]
      for x in range(8):
        if row & (1 << (7 - x)):
          xx = x0 + x
          yy = y0 + y
          if 0 <= xx < W and 0 <= yy < H:
            buf[yy * W + xx] = color

def main():
    os.makedirs("assets/sdroot", exist_ok=True)
    pixels = [0] * (W * H)
    for y in range(H):
        for x in range(W):
            r = (x * 255) // (W - 1)
            g = (y * 255) // (H - 1)
            b = ((x ^ y) & 0xFF)
            pixels[y * W + x] = rgb565(r, g, b)

    text = "MISTABLE PHASE1"
    start_x = (W - len(text) * 8) // 2
    start_y = H // 2 - 4
    white = rgb565(255, 255, 255)
    for i, ch in enumerate(text):
        draw_char(pixels, start_x + i * 8, start_y, ch, white)

    with open(OUT, "wb") as f:
        for p in pixels:
            f.write(bytes((p & 0xFF, (p >> 8) & 0xFF)))

    sz = os.path.getsize(OUT)
    if sz != 153600:
        raise SystemExit(f"bad size: {sz}")
    print(f"wrote {OUT} ({sz} bytes)")

if __name__ == "__main__":
    main()
